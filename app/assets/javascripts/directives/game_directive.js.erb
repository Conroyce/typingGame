app.directive("gameDirective", ["$timeout", "$interval", "$http", function($timeout, $interval, $http) {
  return {
    templateUrl: "<%= asset_path('templates/directives/game_template.html') %>",
    link: function(scope, ele, attr) {
        
      var wordsLeft, total, current, timer, start, transPercent, trans, progBar;

      var calcWPM = function(words,time) {
        var adjust = 60/time;
        scope.wpm = Math.ceil(words * adjust);
      };

      var calcAccuracy = function(words, errors) {
        var correct = words - errors;
        var percent = (correct/words) * 100;
        scope.accuracy = Math.ceil(percent);
      };

      var calcTrans = function(words) {
        transPercent = 1/words;
      };

      // var adjTrans = function() {
      //   var transStr = trans.toString();
      //   scope.imgBackground = {
      //     'opacity': transStr,
      //     'color': 'white',
      //     'font-size': '8em',
      //     'background-color': 'black',
      //     'width': '570px',
      //     'height': '370px',
      //     'position': 'absolute',
      //     'top': '0',
      //     'left': '15px',
      //     'border-radius': '6px',
      //     'text-align': 'center'
      //   };
      // };

      var resetBar = function() {
        scope.progressBar = {
          'width': '0%'
        };
      };
      
      var adjBar = function() {
        progBar += transPercent * 100;
        var progressStr = progBar.toString();
        scope.progressBar = {
          'width': progressStr + "%"
        };
      };

      var startTimer = function() {
        start = new Date();
        timer = $interval(function() {
          scope.time = ((new Date - start) / 1000).toFixed(1);
        });
      };

      var stopTimer = function() {
        $interval.cancel(timer);
      }

      var updateData = function() {
        current = wordsLeft.shift();
        scope.dataCompleted = scope.log.join(" ");
        scope.dataRemain = wordsLeft.join(" ");
        scope.dataCurrent = current;
      };

      scope.createDisplay = function() {
        transPercent = 0;
        progBar = 0;
        trans = 1;
        scope.log = [];      
        scope.count = 0;
        scope.time = 0;
        scope.wpm = 0;
        scope.errors = 0;
        scope.gameStarted = false;
        scope.disable = true;
        scope.gameOver = false;
        scope.gameDisplay = true;
        updateData();
        // adjTrans();
        resetBar();
      };        

      var textDisplay = function(cur, fail) {
        scope.cur = cur;
        scope.fail = fail;
      };     

      // var planeStyle = function(px) {
      //   px -= 75;
      //   scope.planeDown = false;
      //   scope.planeStyle = {
      //     'top':px+'px'
      //   }
      //   scope.planeUp = true;  
      // }; 

      var planeDown = function() {
        var px = $('#plane').offset().top;
        px -= 75;
        console.log(px);
        scope.planeStyle = {
          'top':px+'px'
        };
        scope.planeDown = true;
        scope.planeUp = false;
      }

      var planeUp = function() {
        var px = $('#plane').offset().top;
        console.log(px)
        px -= 75;
        scope.planeStyle = {
          'top':px+'px'
        }
        scope.planeUp = true;
        scope.planeDown = false;
        $timeout(function() {
          scope.planeStyle = { 'top':px+'px' };
          planeDown(px);
        },500);
      }

      var ending = function() {
        var totalTime = (new Date - start)/1000;
        stopTimer();
        scope.ans = "";
        scope.disable = true;
        scope.gameOver = true;
        scope.gameDisplay = false;
        textDisplay(false,false);
        calcWPM(scope.count,scope.time)
        calcAccuracy(scope.count,scope.errors)
        // wordsLeft = data.split(" ");
      };

      var clearStartMes = function() {
        $timeout(function() {
          scope.countDown = "";
        }, 1000)
      };

      scope.startGame = function() {
        scope.gameStarted = true;
        scope.countDown = 5;
        //start countdown
        var dec = $interval(function() { 
          //if we reach 1
          if (scope.countDown === 1) {
            //stop countdown, start timer for typing game
            $interval.cancel(dec);
            scope.countDown = "Go!";
            clearStartMes();
            scope.disable = false;
            textDisplay(true,false);
            scope.planeDown = true;
            scope.planeUp = false;
            startTimer();
            scope.$apply();
            ele[0].querySelector('.text-type').focus();
          } else {
            scope.countDown--;
          }
        },1000);       
      };

      ele.bind("keyup", function(evt){
        //check if spacebar is pressed
        if (evt.keyCode == 32) {
          //if the last word has been entered correctly
          if (current === scope.ans && total == scope.log.length) {
            stopTimer();
            ending();
          //if word is entered correctly  
          } else if (current === scope.ans) {  
            trans -= transPercent;
            // adjTrans();
            var planeCoord = $('#plane').offset();
            planeUp()
            adjBar();
            scope.log.push(scope.ans);
            updateData();
            scope.ans = "";
            scope.count++;
            calcWPM(scope.log.length, (new Date - start)/1000)
            textDisplay(true,false);
          } else {
            scope.errors++;
            textDisplay(false,true);
          }
          scope.$digest();
        } else if(current === scope.ans) {
          textDisplay(true,false);
        }        
      }); 

      $('#plane').bind("animationend webkitAnimationEnd", function() {
        console.log("animation ended!");

      })

      //initalizing function
      scope.startAgain = function(){
        $http.get("http://numbersapi.com/random/trivia").success(function(data) {
          wordsLeft = data.split(" ");
          total = wordsLeft.length - 1;
          scope.createDisplay();
          calcTrans(wordsLeft.length);
          textDisplay(false,false);
        });   
      };

      if ($('#plane').offset.top > 300) {
        console.log("greater than 300.")
      }

      scope.startAgain(); 
    }
  }
}]);
